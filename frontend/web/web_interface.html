<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Teleop - Real-time Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
    <style>
        .camera-container {
            position: relative;
            background: #1f2937;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .processing {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .capture-btn {
            transition: all 0.3s ease;
        }
        .capture-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .capture-btn:disabled {
            transform: none;
            box-shadow: none;
        }
        .result-fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Hand Teleop System</h1>
            <p class="text-gray-600 text-lg">Real-time fingertip tracking for robot control</p>
        </div>
        
        <!-- Main Content -->
        <div class="grid lg:grid-cols-2 gap-8 max-w-6xl mx-auto">
            <!-- Left Side - Camera Feed -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    Live Camera Feed
                </h2>
                
                <!-- Camera Display -->
                <div class="camera-container mb-4">
                    <video id="videoElement" autoplay playsinline class="w-full h-64 object-cover rounded"></video>
                    <canvas id="outputCanvas" class="absolute top-0 left-0 w-full h-64 rounded"></canvas>
                    <canvas id="captureCanvas" class="hidden"></canvas>
                </div>
                
                <!-- Controls -->
                <div class="space-y-4">
                    <button id="startCamera" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg capture-btn">
                        ðŸ“¹ Start Live Tracking
                    </button>
                    
                    <button id="captureBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg capture-btn disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        ðŸ“¸ Capture & Process (WiLoR)
                    </button>
                    
                    <!-- Fingertip Display -->
                    <div id="fingertipData" class="hidden bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-2">Live Fingertips:</h4>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="bg-yellow-100 p-2 rounded">
                                <div class="font-medium text-yellow-800">Thumb Tip</div>
                                <div id="thumbCoords" class="text-yellow-600">-</div>
                            </div>
                            <div class="bg-blue-100 p-2 rounded">
                                <div class="font-medium text-blue-800">Index PIP</div>
                                <div id="pipCoords" class="text-blue-600">-</div>
                            </div>
                            <div class="bg-red-100 p-2 rounded">
                                <div class="font-medium text-red-800">Index Tip</div>
                                <div id="tipCoords" class="text-red-600">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div id="status" class="text-center p-3 rounded-lg bg-blue-50 text-blue-700">
                        Click "Start Camera" to begin
                    </div>
                </div>
            </div>
            
            <!-- Right Side - Results -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Tracking Results
                </h2>
                
                <!-- Results Display -->
                <div id="resultsContainer" class="space-y-4">
                    <!-- Default State -->
                    <div id="defaultState" class="text-center py-8">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gray-200 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m-9 4h10m-10 0V7a2 2 0 012-2h6a2 2 0 012 2v1m-10 0v10a2 2 0 002 2h6a2 2 0 002-2V8"></path>
                            </svg>
                        </div>
                        <p class="text-gray-600">Start live tracking to see real-time fingertip positions</p>
                    </div>
                    
                    <!-- Live Tracking State -->
                    <div id="liveState" class="hidden">
                        <div class="bg-green-50 rounded-lg p-4 mb-4">
                            <div class="flex items-center mb-2">
                                <div class="w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                                <span class="text-green-800 font-medium">Live Tracking Active</span>
                                <span id="fps" class="ml-auto text-green-600 text-sm">- FPS</span>
                            </div>
                            <div class="text-green-700 text-sm">
                                Show your hand to see real-time fingertip detection
                            </div>
                        </div>
                        
                        <!-- Robot Control Preview -->
                        <div id="robotPreview" class="hidden bg-blue-50 rounded-lg p-4 mb-4">
                            <h4 class="font-semibold text-blue-800 mb-2">Robot Control Mapping:</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="text-blue-700">X Position: <span id="robotX" class="font-mono">0.0</span></div>
                                <div class="text-blue-700">Y Position: <span id="robotY" class="font-mono">0.0</span></div>
                                <div class="text-blue-700">Z Position: <span id="robotZ" class="font-mono">0.0</span></div>
                                <div class="text-blue-700">Gripper: <span id="robotGripper" class="font-mono">Open</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Processing State -->
                    <div id="processingState" class="hidden text-center py-8">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-blue-600 font-medium">Processing with WiLoR...</p>
                        <p class="text-gray-500 text-sm mt-2">This may take 20-30 seconds on first run</p>
                    </div>
                    
                    <!-- Results State -->
                    <div id="resultsState" class="hidden">
                        <div id="overlayContainer" class="mb-4">
                            <img id="overlayImage" class="w-full rounded-lg shadow-md" alt="Hand tracking overlay">
                        </div>
                        
                        <div id="handData" class="bg-gray-50 rounded-lg p-4">
                            <h3 class="font-semibold text-gray-800 mb-2">Detection Results:</h3>
                            <div id="handStats" class="text-sm text-gray-600 space-y-1">
                                <!-- Hand statistics will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Error State -->
                    <div id="errorState" class="hidden text-center py-8">
                        <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <p id="errorMessage" class="text-red-600 font-medium"></p>
                    </div>
                </div>
                
                <!-- Instructions -->
                <div class="mt-6 bg-blue-50 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-800 mb-2">How to use:</h4>
                    <ul class="text-blue-700 text-sm space-y-1">
                        <li>â€¢ <strong>Live Tracking:</strong> Real-time fingertip detection with MediaPipe</li>
                        <li>â€¢ <strong>WiLoR Processing:</strong> High-quality capture analysis</li>
                        <li>â€¢ Position your <strong>RIGHT hand</strong> in the camera view</li>
                        <li>â€¢ Three key points: Thumb tip, Index PIP, Index tip</li>
                    </ul>
                    
                    <h4 class="font-semibold text-blue-800 mt-4 mb-2">Overlay Legend:</h4>
                    <ul class="text-blue-700 text-sm space-y-1">
                        <li>â€¢ <span class="inline-block w-3 h-3 bg-yellow-400 rounded-full mr-2"></span>Yellow = Thumb tip</li>
                        <li>â€¢ <span class="inline-block w-3 h-3 bg-blue-500 rounded-full mr-2"></span>Blue = Index PIP joint</li>
                        <li>â€¢ <span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-2"></span>Red = Index fingertip</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Client-side hand tracking with MediaPipe
        class HandTeleopTracker {
            constructor() {
                this.hands = null;
                this.camera = null;
                this.isTracking = false;
                this.fingertips = { thumb: null, indexPip: null, indexTip: null };
                this.fps = 0;
                this.frameCount = 0;
                this.lastTime = performance.now();
                
                // DOM elements
                this.videoElement = document.getElementById('videoElement');
                this.outputCanvas = document.getElementById('outputCanvas');
                this.captureCanvas = document.getElementById('captureCanvas');
                this.ctx = this.outputCanvas.getContext('2d');
                
                this.initializeElements();
            }
            
            initializeElements() {
                this.startBtn = document.getElementById('startCamera');
                this.captureBtn = document.getElementById('captureBtn');
                this.statusDiv = document.getElementById('status');
                this.fingertipData = document.getElementById('fingertipData');
                this.defaultState = document.getElementById('defaultState');
                this.liveState = document.getElementById('liveState');
                this.fpsDisplay = document.getElementById('fps');
                
                // Coordinate displays
                this.thumbCoords = document.getElementById('thumbCoords');
                this.pipCoords = document.getElementById('pipCoords');
                this.tipCoords = document.getElementById('tipCoords');
                
                // Robot preview elements
                this.robotPreview = document.getElementById('robotPreview');
                this.robotX = document.getElementById('robotX');
                this.robotY = document.getElementById('robotY');
                this.robotZ = document.getElementById('robotZ');
                this.robotGripper = document.getElementById('robotGripper');
                
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                this.startBtn.addEventListener('click', () => this.toggleTracking());
                this.captureBtn.addEventListener('click', () => this.captureAndProcess());
            }
            
            async initializeMediaPipe() {
                try {
                    // Initialize MediaPipe Hands
                    this.hands = new Hands({
                        locateFile: (file) => {
                            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                        }
                    });
                    
                    this.hands.setOptions({
                        maxNumHands: 1,
                        modelComplexity: 1,
                        minDetectionConfidence: 0.5,
                        minTrackingConfidence: 0.5
                    });
                    
                    this.hands.onResults((results) => this.onResults(results));
                    
                    // Initialize camera
                    this.camera = new Camera(this.videoElement, {
                        onFrame: async () => {
                            if (this.isTracking) {
                                await this.hands.send({ image: this.videoElement });
                            }
                        },
                        width: 640,
                        height: 480
                    });
                    
                    return true;
                } catch (error) {
                    console.error('MediaPipe initialization failed:', error);
                    return false;
                }
            }
            
            async toggleTracking() {
                if (!this.isTracking) {
                    await this.startTracking();
                } else {
                    this.stopTracking();
                }
            }
            
            async startTracking() {
                this.updateStatus('Initializing MediaPipe...', 'blue');
                
                if (!this.hands && !(await this.initializeMediaPipe())) {
                    this.updateStatus('âŒ Failed to initialize MediaPipe', 'red');
                    return;
                }
                
                try {
                    await this.camera.start();
                    this.isTracking = true;
                    
                    // Update UI
                    this.startBtn.textContent = 'â¹ï¸ Stop Tracking';
                    this.startBtn.className = 'w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg capture-btn';
                    this.captureBtn.disabled = false;
                    
                    this.fingertipData.classList.remove('hidden');
                    this.defaultState.classList.add('hidden');
                    this.liveState.classList.remove('hidden');
                    this.robotPreview.classList.remove('hidden');
                    
                    this.updateStatus('âœ… Live tracking active', 'green');
                    
                    // Start FPS counter
                    this.startFPSCounter();
                    
                } catch (error) {
                    console.error('Error starting camera:', error);
                    this.updateStatus('âŒ Could not access camera', 'red');
                }
            }
            
            stopTracking() {
                this.isTracking = false;
                
                if (this.camera) {
                    this.camera.stop();
                }
                
                // Clear canvas
                this.ctx.clearRect(0, 0, this.outputCanvas.width, this.outputCanvas.height);
                
                // Update UI
                this.startBtn.textContent = 'ï¿½ Start Live Tracking';
                this.startBtn.className = 'w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg capture-btn';
                this.captureBtn.disabled = true;
                
                this.fingertipData.classList.add('hidden');
                this.liveState.classList.add('hidden');
                this.defaultState.classList.remove('hidden');
                this.robotPreview.classList.add('hidden');
                
                this.updateStatus('Tracking stopped', 'blue');
            }
            
            onResults(results) {
                if (!this.isTracking) return;
                
                // Update canvas size
                this.outputCanvas.width = this.videoElement.videoWidth;
                this.outputCanvas.height = this.videoElement.videoHeight;
                
                // Clear previous drawings
                this.ctx.clearRect(0, 0, this.outputCanvas.width, this.outputCanvas.height);
                
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const landmarks = results.multiHandLandmarks[0];
                    
                    // Extract our MVP fingertips (MediaPipe landmark indices)
                    // 4 = thumb tip, 6 = index PIP, 8 = index tip
                    const thumbTip = landmarks[4];
                    const indexPip = landmarks[6];
                    const indexTip = landmarks[8];
                    
                    // Convert to pixel coordinates
                    const w = this.outputCanvas.width;
                    const h = this.outputCanvas.height;
                    
                    this.fingertips = {
                        thumb: { x: thumbTip.x * w, y: thumbTip.y * h, z: thumbTip.z },
                        indexPip: { x: indexPip.x * w, y: indexPip.y * h, z: indexPip.z },
                        indexTip: { x: indexTip.x * w, y: indexTip.y * h, z: indexTip.z }
                    };
                    
                    // Draw fingertips
                    this.drawFingertips();
                    
                    // Update displays
                    this.updateCoordinateDisplays();
                    this.updateRobotMapping();
                    
                } else {
                    // No hand detected
                    this.fingertips = { thumb: null, indexPip: null, indexTip: null };
                    this.updateCoordinateDisplays();
                }
                
                this.updateFPS();
            }
            
            drawFingertips() {
                const { thumb, indexPip, indexTip } = this.fingertips;
                
                // Draw connections
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.moveTo(indexPip.x, indexPip.y);
                this.ctx.lineTo(indexTip.x, indexTip.y);
                this.ctx.stroke();
                
                // Draw fingertip points
                this.drawPoint(thumb.x, thumb.y, '#FCD34D', 8); // Yellow - thumb
                this.drawPoint(indexPip.x, indexPip.y, '#3B82F6', 6); // Blue - PIP
                this.drawPoint(indexTip.x, indexTip.y, '#EF4444', 8); // Red - tip
                
                // Draw labels
                this.ctx.fillStyle = 'white';
                this.ctx.font = 'bold 12px sans-serif';
                this.ctx.fillText('T', thumb.x - 6, thumb.y + 4);
                this.ctx.fillText('P', indexPip.x - 6, indexPip.y + 4);
                this.ctx.fillText('I', indexTip.x - 6, indexTip.y + 4);
            }
            
            drawPoint(x, y, color, size = 6) {
                this.ctx.fillStyle = color;
                this.ctx.beginPath();
                this.ctx.arc(x, y, size, 0, 2 * Math.PI);
                this.ctx.fill();
                
                // White border
                this.ctx.strokeStyle = 'white';
                this.ctx.lineWidth = 2;
                this.ctx.stroke();
            }
            
            updateCoordinateDisplays() {
                const { thumb, indexPip, indexTip } = this.fingertips;
                
                this.thumbCoords.textContent = thumb ? 
                    `(${Math.round(thumb.x)}, ${Math.round(thumb.y)})` : 'Not detected';
                this.pipCoords.textContent = indexPip ? 
                    `(${Math.round(indexPip.x)}, ${Math.round(indexPip.y)})` : 'Not detected';
                this.tipCoords.textContent = indexTip ? 
                    `(${Math.round(indexTip.x)}, ${Math.round(indexTip.y)})` : 'Not detected';
            }
            
            updateRobotMapping() {
                const { thumb, indexPip, indexTip } = this.fingertips;
                
                if (thumb && indexPip && indexTip) {
                    // Simple mapping for robot control preview
                    const x = ((indexTip.x / this.outputCanvas.width) - 0.5) * 2; // -1 to 1
                    const y = ((indexTip.y / this.outputCanvas.height) - 0.5) * -2; // -1 to 1 (inverted Y)
                    const z = Math.max(0, indexTip.z * 2); // 0 to 2
                    
                    // Gripper control based on thumb-index distance
                    const distance = Math.sqrt(
                        Math.pow(thumb.x - indexTip.x, 2) + 
                        Math.pow(thumb.y - indexTip.y, 2)
                    );
                    const gripper = distance < 50 ? 'Closed' : 'Open';
                    
                    this.robotX.textContent = x.toFixed(2);
                    this.robotY.textContent = y.toFixed(2);
                    this.robotZ.textContent = z.toFixed(2);
                    this.robotGripper.textContent = gripper;
                } else {
                    this.robotX.textContent = '0.0';
                    this.robotY.textContent = '0.0';
                    this.robotZ.textContent = '0.0';
                    this.robotGripper.textContent = 'Open';
                }
            }
            
            startFPSCounter() {
                this.frameCount = 0;
                this.lastTime = performance.now();
            }
            
            updateFPS() {
                this.frameCount++;
                const now = performance.now();
                if (now - this.lastTime >= 1000) {
                    this.fps = Math.round(this.frameCount * 1000 / (now - this.lastTime));
                    this.fpsDisplay.textContent = `${this.fps} FPS`;
                    this.frameCount = 0;
                    this.lastTime = now;
                }
            }
            
            async captureAndProcess() {
                // Keep the original WiLoR functionality
                if (!this.isTracking) return;
                
                this.updateStatus('Processing with WiLoR...', 'orange');
                
                try {
                    // Capture current frame
                    const canvas = this.captureCanvas;
                    const context = canvas.getContext('2d');
                    
                    canvas.width = this.videoElement.videoWidth;
                    canvas.height = this.videoElement.videoHeight;
                    context.drawImage(this.videoElement, 0, 0);
                    
                    // Convert to blob
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
                    
                    // Create form data
                    const formData = new FormData();
                    formData.append('file', blob, 'capture.jpg');
                    
                    // Send to API (when backend is available)
                    const response = await fetch('/api/process-hand', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.updateStatus('âœ… WiLoR processing complete!', 'green');
                        // Handle WiLoR results...
                    } else {
                        this.updateStatus('âŒ No hand detected in WiLoR', 'red');
                    }
                    
                } catch (error) {
                    console.log('WiLoR backend not available - using live tracking only');
                    this.updateStatus('ðŸ“± Live tracking active (WiLoR offline)', 'blue');
                }
            }
            
            updateStatus(message, color) {
                this.statusDiv.textContent = message;
                this.statusDiv.className = 'text-center p-3 rounded-lg';
                
                switch(color) {
                    case 'green':
                        this.statusDiv.classList.add('bg-green-50', 'text-green-700');
                        break;
                    case 'red':
                        this.statusDiv.classList.add('bg-red-50', 'text-red-700');
                        break;
                    case 'orange':
                        this.statusDiv.classList.add('bg-orange-50', 'text-orange-700');
                        break;
                    default:
                        this.statusDiv.classList.add('bg-blue-50', 'text-blue-700');
                }
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.handTracker = new HandTeleopTracker();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.handTracker && window.handTracker.camera) {
                window.handTracker.camera.stop();
            }
        });
    </script>
</body>
</html>
