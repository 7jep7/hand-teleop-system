name: 🚀 Auto Deploy to Render

on:
  push:
    branches: [ main ]
    # Only deploy when these files change
    paths:
      - 'backend/**'
      - 'core/**'
      - 'requirements*.txt'
      - 'main.py'
      - 'render.yaml'

jobs:
  deploy:
    name: 🌐 Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🔍 Validate deployment files
      run: |
        echo "🔍 Checking deployment readiness..."
        
        # Check critical files exist
        required_files=(
          "main.py"
          "requirements.txt" 
          "requirements-deploy.txt"
          "render.yaml"
          "backend/render_backend.py"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "✅ $file exists"
          else
            echo "❌ $file missing"
            exit 1
          fi
        done

    - name: 🐍 Test Python setup
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: 🔧 Test basic imports
      run: |
        pip install -r requirements.txt
        python -c "
        try:
            import core
            print('✅ Core module imports successfully')
            from backend.render_backend import app
            print('✅ Backend app imports successfully')
        except Exception as e:
            print(f'❌ Import test failed: {e}')
            exit(1)
        "

    - name: 📡 Trigger Render deployment
      run: |
        echo "🚀 Deployment will be triggered automatically by Render"
        echo "   Render detects commits to main branch and deploys automatically"
        echo "   Check your Render dashboard for deployment status"
        echo "   URL: https://hand-teleop-api.onrender.com"

    - name: ⏱️ Wait for deployment (optional)
      run: |
        echo "⏱️ Waiting 30 seconds for deployment to start..."
        sleep 30
        
        echo "🔍 Testing if new deployment is live..."
        for i in {1..10}; do
          if curl -f -s https://hand-teleop-api.onrender.com/api/health > /dev/null; then
            echo "✅ Deployment appears to be live!"
            break
          else
            echo "⏳ Waiting for deployment... (attempt $i/10)"
            sleep 30
          fi
        done

    - name: 📊 Post-deployment validation
      run: |
        echo "🧪 Running post-deployment smoke tests..."
        
        # Test health endpoint
        if curl -f -s https://hand-teleop-api.onrender.com/api/health; then
          echo "✅ Health endpoint working"
        else
          echo "⚠️ Health endpoint not responding (might be cold start)"
        fi
        
        echo "🎯 Deployment completed!"
        echo "🌐 Production URL: https://hand-teleop-api.onrender.com"
