name: ğŸš€ Auto Deploy to Render

on:
  push:
    branches: [ main ]
    # Only deploy when these files change
    paths:
      - 'backend/**'
      - 'core/**'
      - 'requirements*.txt'
      - 'main.py'
      - 'render.yaml'

jobs:
  deploy:
    name: ğŸŒ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Validate deployment files
      run: |
        echo "ğŸ” Checking deployment readiness..."
        
        # Check critical files exist
        required_files=(
          "main.py"
          "requirements.txt" 
          "requirements-deploy.txt"
          "render.yaml"
          "backend/render_backend.py"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done

    - name: ğŸ Test Python setup
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ”§ Test basic imports
      run: |
        pip install -r requirements.txt
        python -c "
        try:
            import core
            print('âœ… Core module imports successfully')
            from backend.render_backend import app
            print('âœ… Backend app imports successfully')
        except Exception as e:
            print(f'âŒ Import test failed: {e}')
            exit(1)
        "

    - name: ğŸ“¡ Trigger Render deployment
      run: |
        echo "ğŸš€ Deployment will be triggered automatically by Render"
        echo "   Render detects commits to main branch and deploys automatically"
        echo "   Check your Render dashboard for deployment status"
        echo "   URL: https://hand-teleop-api.onrender.com"

    - name: â±ï¸ Wait for deployment (optional)
      run: |
        echo "â±ï¸ Waiting 30 seconds for deployment to start..."
        sleep 30
        
        echo "ğŸ” Testing if new deployment is live..."
        for i in {1..10}; do
          if curl -f -s https://hand-teleop-api.onrender.com/api/health > /dev/null; then
            echo "âœ… Deployment appears to be live!"
            break
          else
            echo "â³ Waiting for deployment... (attempt $i/10)"
            sleep 30
          fi
        done

    - name: ğŸ“Š Post-deployment validation
      run: |
        echo "ğŸ§ª Running post-deployment smoke tests..."
        
        # Test health endpoint
        if curl -f -s https://hand-teleop-api.onrender.com/api/health; then
          echo "âœ… Health endpoint working"
        else
          echo "âš ï¸ Health endpoint not responding (might be cold start)"
        fi
        
        echo "ğŸ¯ Deployment completed!"
        echo "ğŸŒ Production URL: https://hand-teleop-api.onrender.com"
