name: 🚀 Auto Deploy to Render

on:
  push:
    branches: [ main ]
    # Only deploy when these files change
    paths:
      - 'backend/**'
      - 'core/**'
      - 'requirements*.txt'
      - 'main.py'
      - 'render.yaml'

jobs:
  deploy:
    name: 🌐 Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🔍 Validate deployment files
      run: |
        echo "🔍 Checking deployment readiness..."
        
        # Check critical files exist
        required_files=(
          "main.py"
          "requirements.txt" 
          "requirements-deploy.txt"
          "render.yaml"
          "backend/render_backend.py"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "✅ $file exists"
          else
            echo "❌ $file missing"
            exit 1
          fi
        done

    - name: 🐍 Test Python setup
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: 🔧 Test basic imports
      run: |
        pip install -r requirements.txt
        python -c "
        try:
            import core
            print('✅ Core module imports successfully')
            from backend.render_backend import app
            print('✅ Backend app imports successfully')
        except Exception as e:
            print(f'❌ Import test failed: {e}')
            exit(1)
        "

    - name: 📡 Trigger Render deployment
      env:
        RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
      run: |
        echo "🚀 Triggering Render deployment via Deploy Hook..."
        echo "Commit: $(git rev-parse --short HEAD)"
        
        # Use Render Deploy Hook if available
        if [ -n "$RENDER_DEPLOY_HOOK" ]; then
          echo "📡 Calling Render Deploy Hook..."
          curl -X POST "$RENDER_DEPLOY_HOOK" \
            -H "Content-Type: application/json" \
            -d '{"ref": "main", "commit": "'$(git rev-parse HEAD)'"}' \
            || echo "⚠️ Deploy hook call failed, but continuing..."
        else
          echo "⚠️ RENDER_DEPLOY_HOOK secret not set"
          echo "💡 Please add your Render deploy hook URL as a GitHub secret"
          echo "   Go to: GitHub repo → Settings → Secrets → Actions"
          echo "   Add secret: RENDER_DEPLOY_HOOK = your-render-deploy-hook-url"
        fi
        
        echo "🔍 Auto-deploy should also trigger if webhook is working"

    - name: ⏱️ Wait for deployment (optional)
      run: |
        echo "⏱️ Waiting 30 seconds for deployment to start..."
        sleep 30
        
        echo "🔍 Testing if new deployment is live..."
        for i in {1..10}; do
          if curl -f -s https://hand-teleop-api.onrender.com/api/health > /dev/null; then
            echo "✅ Deployment appears to be live!"
            break
          else
            echo "⏳ Waiting for deployment... (attempt $i/10)"
            sleep 30
          fi
        done

    - name: 📊 Post-deployment validation
      run: |
        echo "🧪 Running post-deployment smoke tests..."
        
        # Test health endpoint
        if curl -f -s https://hand-teleop-api.onrender.com/api/health; then
          echo "✅ Health endpoint working"
        else
          echo "⚠️ Health endpoint not responding (might be cold start)"
        fi
        
        echo "🎯 Deployment completed!"
        echo "🌐 Production URL: https://hand-teleop-api.onrender.com"
